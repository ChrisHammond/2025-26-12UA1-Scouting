---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import RatingHistoryChart from "../../components/RatingHistoryChart.astro";
import settings from "../../config/settings";

export async function getStaticPaths() {
  const teams = await getCollection("teams");
  return teams.map((t) => ({
    params: { slug: t.data.slug },
    props: { team: t.data },
  }));
}

const { team } = Astro.props;

// Load all teams so we can find "our" team for matchup preview
const allTeams = (await getCollection("teams")).map((t) => t.data);
const myTeam = allTeams.find((t) => t.slug === settings.teamSlug);

// Load games (vs this opponent)
const games = (await getCollection("games"))
  .map((g) => g.data)
  .filter((g) => g.opponent === team.slug || g.opponentSlug === team.slug)
  .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

// Load tournaments
const tournaments = (await getCollection("tournaments")).map((t) => t.data);
function getTournament(slug: string) {
  return tournaments.find((t) => t.slug === slug);
}

// Load rating history from src/data/mhr-history/<slug>.json
const histMods = import.meta.glob("../../data/mhr-history/*.json", { eager: true });
const histKey = `../../data/mhr-history/${team.slug}.json`;
const ratingHistory = (histMods[histKey]?.default ?? [])
  .filter((p: any) => p && p.date && typeof p.rating === "number")
  .sort((a: any, b: any) => a.date.localeCompare(b.date));

// --- Matchup preview helpers ---
const isSelf = team.slug === settings.teamSlug;
const SCALE = 6;
function winProb(rA?: number, rB?: number) {
  if (typeof rA !== "number" || typeof rB !== "number") return undefined;
  return 1 / (1 + Math.exp(-(rA - rB) / SCALE));
}
const prob =
  !isSelf && myTeam ? winProb(myTeam?.rating as number, team?.rating as number) : undefined;
const probLabel =
  typeof prob === "number" ? `${Math.round(prob * 100)}%` : "—";
const ratingDiff =
  typeof myTeam?.rating === "number" && typeof team?.rating === "number"
    ? (myTeam.rating - team.rating).toFixed(2)
    : null;
---

<BaseLayout title={`${team.name} – ${settings.portalName}`}>
  <a href="/teams/" class="text-white hover:text-red-400">← Back to Teams</a>
  <h1 class="text-2xl font-bold text-red-500 mt-2">{team.name}</h1>

  <!-- Team meta -->
  <div class="mt-2 text-gray-300 space-y-1">
    {team.division && <p>Division: {team.division}</p>}
    {team.league && <p>League: {team.league}</p>}
    {team.record && <p>Record: {team.record}</p>}
    {typeof team.rating === "number" && <p>Current MHR Rating: {team.rating.toFixed(2)}</p>}
    {team.website && (
      <p>Website: <a href={team.website} target="_blank" rel="noopener" class="underline hover:text-red-400">{team.website}</a></p>
    )}
    {team.mhrUrl && (
      <p>MHR: <a href={team.mhrUrl} target="_blank" rel="noopener" class="underline hover:text-red-400">{team.mhrUrl}</a></p>
    )}
  </div>

  <!-- Ranks row -->
  <div class="mt-3 flex flex-wrap gap-2">
    <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-red-600 bg-red-600/20 text-red-300">
      <span class="text-xs uppercase tracking-wide">State Rank</span>
      <span class="font-semibold text-white">{typeof team.mhrStateRank === "number" ? `#${team.mhrStateRank}` : "—"}</span>
    </span>
    <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-red-600 bg-red-600/20 text-red-300">
      <span class="text-xs uppercase tracking-wide">National Rank</span>
      <span class="font-semibold text-white">{typeof team.mhrNationalRank === "number" ? `#${team.mhrNationalRank}` : "—"}</span>
    </span>
    {team.lastUpdated && (
      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-gray-700 bg-gray-800 text-gray-300">
        <span class="text-xs uppercase tracking-wide">Updated</span>
        <span class="font-mono">{team.lastUpdated}</span>
      </span>
    )}
  </div>

  <!-- Matchup preview card -->
  {!isSelf && myTeam && (
    <section class="mt-6">
      <div class="bg-gray-900 rounded-lg p-4 border border-red-600">
        <h2 class="text-lg font-semibold text-red-400 mb-2">Matchup vs {myTeam.name}</h2>

        <div class="flex flex-wrap items-center gap-3 text-sm">
          <span class="inline-block rounded px-2 py-0.5 bg-gray-700 text-gray-200">
            Win % for {myTeam.name}: <strong class="ml-1">{probLabel}</strong>
          </span>
          {ratingDiff && (
            <span class="inline-block rounded px-2 py-0.5 bg-gray-800 text-gray-300">
              Rating Δ (us - them): <strong class="ml-1">{ratingDiff}</strong>
            </span>
          )}
          {typeof myTeam.mhrNationalRank === "number" && typeof team.mhrNationalRank === "number" && (
            <span class="inline-block rounded px-2 py-0.5 bg-gray-800 text-gray-300">
              Nat Rank: <strong class="ml-1">#{myTeam.mhrNationalRank}</strong> vs <strong class="ml-1">#{team.mhrNationalRank}</strong>
            </span>
          )}
        </div>

        <div class="mt-3">
          <a href={`/matchups/${team.slug}/`} class="inline-block rounded-lg border border-red-600 bg-red-600/20 px-3 py-1.5 text-sm text-red-200 hover:bg-red-600/30">
            Open full matchup
          </a>
        </div>
      </div>
    </section>
  )}

  <!-- Rating trend -->
  <section class="mt-6">
    <RatingHistoryChart points={ratingHistory} title="MHR Rating Trend" />
  </section>

  <!-- Games table -->
  <h2 class="text-xl font-semibold text-red-500 mt-8 mb-2">Games vs {team.name}</h2>

  {games.length === 0 ? (
    <p class="text-gray-300">No games recorded yet against this team.</p>
  ) : (
    <div class="overflow-x-auto rounded-lg border border-red-600">
      <table class="min-w-full text-sm">
        <thead class="bg-red-600 text-white uppercase text-xs">
          <tr>
            <th class="px-3 py-2 text-left">Date</th>
            <th class="px-3 py-2">Home/Away</th>
            <th class="px-3 py-2">League</th>
            <th class="px-3 py-2 text-left">Tournament</th>
            <th class="px-3 py-2 text-left">Venue</th>
            <th class="px-3 py-2 text-left">Result</th>
          </tr>
        </thead>
        <tbody class="bg-gray-900 divide-y divide-gray-700">
          {games.map((g) => {
            const tourney = g.tournament ? getTournament(g.tournament) : null;
            return (
              <tr class="hover:bg-gray-800">
                <td class="px-3 py-2">{new Date(g.date).toLocaleDateString()}</td>
                <td class="px-3 py-2">{g.homeAway}</td>
                <td class="px-3 py-2">{g.leagueGame ? "Yes" : "No"}</td>
                <td class="px-3 py-2">
                  {tourney ? <a class="underline hover:text-red-400" href={`/tournaments/${tourney.slug}/`}>{tourney.name}</a> : "—"}
                </td>
                <td class="px-3 py-2">{g.venue ?? "—"}</td>
                <td class="px-3 py-2">{g.result ? `${g.result} ${g.scoreFor}-${g.scoreAgainst}` : "—"}</td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  )}
</BaseLayout>
