---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import settings from "../config/settings";

// Manual games (content)
const manualGames = (await getCollection("games")).map((g) => g.data);

// Auto (generated) for your team
const autoMods = import.meta.glob("../data/auto-schedule/*.json", { eager: true });
const autoGames = (autoMods[`../data/auto-schedule/${settings.teamSlug}.json`]?.default ?? []);

// Merge & de-duplicate by date+time+opponent (manual overrides auto on conflict)
const key = (g) => [g.date, g.time ?? "", (g.opponent ?? "").toLowerCase()].join("|");
const mergedMap = new Map();
[...autoGames, ...manualGames].forEach((g) => mergedMap.set(key(g), g));
const games = [...mergedMap.values()].sort((a, b) => (a.date + (a.time ?? "")).localeCompare(b.date + (b.time ?? "")));
---

<BaseLayout title="Schedule">
  <h1 class="text-2xl font-bold text-red-500 mb-4">Schedule</h1>
  {games.length === 0 ? (
    <p class="text-gray-300">No games found.</p>
  ) : (
    <div class="overflow-x-auto rounded-lg border border-red-600">
      <table class="min-w-full text-sm">
        <thead class="bg-red-600 text-white uppercase text-xs">
          <tr>
            <th class="px-3 py-2 text-left">Date</th>
            <th class="px-3 py-2 text-left">Time</th>
            <th class="px-3 py-2 text-left">Opponent</th>
            <th class="px-3 py-2 text-left">Home/Away</th>
            <th class="px-3 py-2 text-left">Venue</th>
            <th class="px-3 py-2 text-left">Source</th>
          </tr>
        </thead>
        <tbody class="bg-gray-900 divide-y divide-gray-700">
          {games.map((g) => (
            <tr class="hover:bg-gray-800">
              <td class="px-3 py-2">{g.date}</td>
              <td class="px-3 py-2">{g.time ?? "—"}</td>
              <td class="px-3 py-2">{g.opponent ?? "TBD"}</td>
              <td class="px-3 py-2">{g.homeAway ?? "Neutral"}</td>
              <td class="px-3 py-2">{g.venue ?? "—"}</td>
              <td class="px-3 py-2 uppercase text-xs text-gray-400">{g.source ?? "manual"}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )}
</BaseLayout>
