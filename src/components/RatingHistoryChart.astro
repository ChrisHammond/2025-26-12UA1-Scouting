---
/* RatingHistoryChart.astro
   Props:
     - points: Array<{ date: string; rating: number }>
     - title?: string
*/
const { points = [], title = "MHR Rating Trend" } = Astro.props;
// Ensure chronological order (YYYY-MM-DD strings sort lexicographically)
const data = [...points].sort((a, b) => a.date.localeCompare(b.date));
// Generate a stable id for the canvas
const id = `mhr-chart-${Math.random().toString(36).slice(2)}`;
---

<div class="bg-gray-900 rounded-lg p-4 border border-red-600">
  <h3 class="text-lg font-bold text-red-400 mb-2">{title}</h3>
  {data.length > 1 ? (
    <>
      <canvas id={id} height="140"></canvas>
      <script type="application/json" id={`${id}-data`}>{JSON.stringify(data)}</script>
      <script type="module">
        import Chart from "chart.js/auto";
        const el = document.getElementById("{id}");
        const raw = document.getElementById("{id}-data").textContent;
        const series = JSON.parse(raw);

        const labels = series.map(p => p.date);
        const ratings = series.map(p => p.rating);

        // Create chart
        const ctx = el.getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "MHR Rating",
              data: ratings,
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 2
            }]
          },
          options: {
            responsive: true,
            interaction: { mode: "index", intersect: false },
            plugins: {
              legend: { labels: { color: "#ffffff" } },
              tooltip: { enabled: true }
            },
            scales: {
              x: { ticks: { color: "#d1d5db" }, grid: { color: "rgba(255,255,255,0.08)" } },
              y: { ticks: { color: "#d1d5db" }, grid: { color: "rgba(255,255,255,0.08)" } }
            }
          }
        });
      </script>
    </>
  ) : (
    <p class="text-gray-300">Not enough history yet. Run your MHR updater a few times to build trend data.</p>
  )}
</div>
